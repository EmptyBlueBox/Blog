---
import type { MarkdownHeading } from 'astro'
import PageLayout from '@/layouts/BaseLayout.astro'
import type { CollectionEntry } from 'astro:content'
import socialCard from '@/assets/og/social_card.jpg'

import { Comment } from '@/components/advanced'
import AnimatedSignature from '@/components/blog/AnimatedSignature.astro'
import ArticleBottom from '@/components/blog/ArticleBottom.astro'
import Copyright from '@/components/blog/Copyright.astro'
import BlogHero from '@/components/blog/Hero.astro'
import MermaidFixed from '@/components/MermaidFixed.astro'
import MobileTOC from '@/components/pages/MobileTOC.astro'
import TOC from '@/components/pages/TOC.astro'
import { Button } from '@/components/user'

// Plugin styles
import '@waline/client/style'
import 'katex/dist/katex.min.css'

import { MediumZoom } from '@/components/advanced'
import { cn } from '@/utils'
import { integrationConfig } from '@/site-config'
import StructuredData from '@/components/StructuredData.astro'

interface Props {
  post: CollectionEntry<'post'>
  headings: MarkdownHeading[]
  translations?: {
    href: string
    label: string
    isActive: boolean
  }[]
  commentPath?: string
}

const { post, headings, translations = [], commentPath } = Astro.props
const {
  data: { description, heroImage, publishDate, title, updatedDate }
} = post
const socialImage = heroImage
  ? typeof heroImage.src === 'string'
    ? heroImage.src
    : heroImage.src.src
  : socialCard.src
const articleDate = updatedDate?.toISOString() ?? publishDate.toISOString()
const primaryColor = post.data.heroImage?.color ?? 'hsl(var(--primary) / var(--tw-text-opacity))'
---

<PageLayout
  meta={{ articleDate, description, ogImage: socialImage, title }}
  highlightColor={primaryColor}
>
  <StructuredData type="article" post={post} slot="head" />
  <div class='w-full'>
    <div class='flex flex-col items-start gap-2 sm:flex-row sm:items-center sm:justify-between'>
      <Button title='Back' href='/blog' style='back' />
    </div>
    <div class='mt-6 w-full items-start gap-x-10 md:flex'>
      {
        !!headings.length && (
          <TOC
            class='animate top-24 z-10 min-w-40 basis-60 max-md:hidden md:sticky md:order-2 lg:shrink-0'
            {headings}
          />
        )
      }
      <article class='min-w-0 grow' data-pagefind-body>
        <div id='content-header' class='animate'>
          <BlogHero content={post} translations={translations} commentPath={commentPath} />
        </div>
        <div
          id='content'
          class={cn(
            'animate mt-8 max-w-none md:min-w-[45ch] lg:mx-auto lg:max-w-[55ch] [&_:not(pre)>code]:border [&_:not(pre)>code]:border-neutral-300 [&_:not(pre)>code]:rounded-md [&_:not(pre)>code]:px-1.5 [&_:not(pre)>code]:py-0.5 [&_:not(pre)>code]:bg-neutral-100 [&_:not(pre)>code]:text-[#476582] [&_:not(pre)>code]:font-normal [&_:not(pre)>code::before]:hidden [&_:not(pre)>code::after]:hidden dark:[&_:not(pre)>code]:bg-neutral-800 dark:[&_:not(pre)>code]:border-neutral-700 dark:[&_:not(pre)>code]:text-[#AAC8E4]',
            integrationConfig.typography.class
          )}
        >
          <slot />
          <AnimatedSignature />
        </div>
      </article>
    </div>

    <div class='mt-8 w-full items-start gap-x-10 md:flex'>
      <div class='mt-8 flex-1 text-muted-foreground md:min-w-[50ch]'>
        {/* Copyright */}
        <Copyright content={post} />
        {/* Article recommend */}
        <ArticleBottom content={post} class='mt-3 sm:mt-6' />
        {/* Comment */}
        {!post.data.draft && <Comment class='mt-3 sm:mt-6' path={commentPath ?? `/blog/${post.slug}`} />}
      </div>
      <div class='min-w-40 basis-60'>
        <slot name='bottom' />
      </div>
    </div>
    {!!headings.length && <MobileTOC headings={headings} />}
  </div>
</PageLayout>

{integrationConfig.mediumZoom.enable && <MediumZoom />}
<MermaidFixed />
