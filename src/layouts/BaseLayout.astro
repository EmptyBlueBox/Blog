---
import type { SiteMeta } from '@/types'

import BaseHead from '@/components/BaseHead.astro'
import Footer from '@/components/layout/Footer.astro'
import Header from '@/components/layout/Header.astro'
import ThemeProvider from '@/components/layout/ThemeProvider.astro'
import { siteConfig } from '@/site-config'

// Import the global.css file here so that it is included on
// all pages through the use of the <BaseLayout /> component.
import '@/assets/styles/app.css'

// Vercel Analytics
// import Analytics from '@vercel/analytics/astro'

interface Props {
  meta: SiteMeta
  highlightColor?: string
}

const {
  meta: { articleDate, description = siteConfig.description, ogImage, title },
  highlightColor
} = Astro.props
---

<html lang={siteConfig.lang}>
  <head>
    <BaseHead articleDate={articleDate} description={description} ogImage={ogImage} title={title} />
    <!-- Analytics - Load only when user interacts or after delay -->
    <script is:inline>
      let analyticsLoaded = false;
      
      function loadAnalytics() {
        if (analyticsLoaded) return;
        analyticsLoaded = true;
        
        // Google Analytics - Only load if user seems engaged
        const gtagScript = document.createElement('script');
        gtagScript.async = true;
        gtagScript.src = 'https://www.googletagmanager.com/gtag/js?id=G-TZ8JVZJ6BM';
        document.head.appendChild(gtagScript);
        
        gtagScript.onload = function() {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-TZ8JVZJ6BM', {
            send_page_view: true,
            transport_type: 'beacon'
          });
        };
        
        // Umami Analytics - Lightweight, load faster
        const umamiScript = document.createElement('script');
        umamiScript.src = 'https://umami.arthals.ink/script.js';
        umamiScript.setAttribute('data-website-id', '214f27d3-33cd-40c6-828a-814a4b1716b8');
        umamiScript.defer = true;
        document.head.appendChild(umamiScript);
      }
      
      // Load analytics when user shows engagement
      const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
      events.forEach(function(event) {
        document.addEventListener(event, loadAnalytics, { once: true, passive: true });
      });
      
      // Fallback: load after 5 seconds if no interaction
      setTimeout(loadAnalytics, 5000);
    </script>
    <ThemeProvider />
  </head>

  <body class='flex justify-center bg-background transition-colors'>
    {
      highlightColor && highlightColor != 'hsl(var(--primary) / var(--tw-text-opacity))' && (
        <>
          <div
            class='pointer-events-none absolute start-0 top-0 z-0 h-1/2 w-full opacity-25'
            style={{ backgroundImage: `linear-gradient(${highlightColor}, transparent)` }}
          />
          <style define:vars={{ highlightColor }}>
            :global(.highlight) {
              color: var(--highlightColor) !important;
            }
            :global(.highlight-bg) {
              background-color: var(--highlightColor) !important;
            }
          </style>
        </>
      )
    }
    <main
      class='z-10 flex min-h-screen w-screen flex-col items-center px-4 pb-10 text-[0.92rem] leading-relaxed sm:px-7 lg:px-10'
    >
      <Header />
      <div class='mx-auto w-full lg:max-w-[70vw]'>
        <slot />
      </div>
      <Footer />
    </main>

  </body>
</html>
