---
const { repo: repoRaw } = Astro.props

// Remove 'https://github.com/' headings from the repo string
const repo = repoRaw.replace(/^https:\/\/github\.com\//, '')

const [owner, repoName] = repo.split('/')
---

<github-card class='not-prose loading my-4 block' data-repo={repo}>
  <a
    href={`https://github.com/${repo}`}
    target='_blank'
    class='group block flex flex-col gap-y-2 rounded-2xl border border-border px-5 py-4 transition-colors hover:bg-muted hover:text-muted-foreground'
  >
    <div class='flex items-center justify-between'>
      <div class='flex items-center gap-x-2 text-foreground group-hover:text-primary'>
        <div id='gh-avatar' class='gh-text me-2 size-8 bg-cover' style='border-radius:999px'></div>
        <span class='text-lg transition-colors'>{owner}</span>
        <span class='text-muted-foreground'>/</span>
        <span class='text-lg font-bold transition-colors'>{repoName}</span>
      </div>
      <div class='rounded-full p-0'>
        <svg class='size-6'>
          <use href='/icons/social.svg#mingcute-github-line'></use>
        </svg>
      </div>
    </div>
    <p id='gh-description' class='gh-text'>No Description Specified</p>
    <div class='flex items-center justify-between'>
      <div class='gh-text flex flex-wrap items-center gap-x-5'>
        <div class='flex items-center gap-x-2'>
          <svg class='size-5'><use href='/icons/github-card.svg#mingcute-star-line'></use></svg>
          <span id='gh-stars' class='leading-tight'>No Stars Specified</span>
        </div>
        <div class='flex items-center gap-x-2'>
          <svg class='size-5'
            ><use href='/icons/github-card.svg#mingcute-git-branch-line'></use></svg
          >
          <span id='gh-forks' class='leading-tight'>No Forks Specified</span>
        </div>
        <div class='flex items-center gap-x-2'>
          <svg class='size-5'><use href='/icons/github-card.svg#mingcute-balance-line'></use></svg>
          <span id='gh-license' class='leading-tight'>No License Specified</span>
        </div>
      </div>
      <span id='gh-language' class='gh-text leading-tight'>No Language Specified</span>
    </div>
  </a>
</github-card>

<style>
  @keyframes pulsate {
    0% {
      opacity: 1;
    }
    50% {
      opacity: 0.4;
    }
    to {
      opacity: 1;
    }
  }
  .loading .gh-text {
    color: transparent;
    border-radius: calc(var(--radius) - 3px);
    background-color: hsl(var(--primary-foreground) / var(--tw-text-opacity));
    animation: pulsate 2s infinite linear;
    user-select: none;
  }
  .loading .gh-text:nth-child(2) {
    animation-delay: 1s;
  }
</style>

<script>
  interface GithubProps {
    stargazers_count: number
    forks: number
    language: string
    owner: { avatar_url: string }
    license?: { spdx_id: string }
    description: string
  }
  type FetchResult = GithubProps | 'NOT_FOUND' | null

  class GithubCard extends HTMLElement {
    /**
     * Fetch GitHub repository metadata for a given repo path.
     *
     * Parameters:
     * - repo (string): Repository path in the form "owner/name".
     *
     * Returns:
     * - (GithubProps | 'NOT_FOUND' | null): Parsed metadata when successful;
     *   the sentinel string 'NOT_FOUND' when the repository returns 404;
     *   or null for other fetch errors.
     */
    async fetchGithub(repo: string): Promise<FetchResult> {
      try {
        const res = await fetch(`https://api.github.com/repos/${repo}`, {
          referrerPolicy: 'no-referrer',
          headers: {
            Accept: 'application/vnd.github+json',
            'X-GitHub-Api-Version': '2022-11-28'
          }
        })
        if (res.status === 404) {
          return 'NOT_FOUND'
        }
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`)
        }
        return (await res.json()) as GithubProps
      } catch (e) {
        console.error('Failed to fetch Github data:', e)
        return null
      }
    }

    /**
     * Compactly format large integer counts using locale-aware rules.
     *
     * Parameters:
     * - value (number): Positive integer count.
     *
     * Returns:
     * - (string): Formatted string like "1.2K".
     */
    numberFormat(value: number): string {
      return Intl.NumberFormat('en-us', {
        notation: 'compact',
        maximumFractionDigits: 1
      }).format(value)
    }

    /**
     * Lifecycle hook invoked when the custom element is attached to the DOM.
     * Performs data fetch and populates the internal DOM nodes.
     *
     * Parameters:
     * - None
     *
     * Returns:
     * - (Promise<void>): Resolves after DOM has been updated.
     */
    async connectedCallback() {
      if (!this.dataset.repo) {
        ;(this.querySelector('#gh-description') as HTMLElement).textContent =
          'Repository not specified'
        this.classList.remove('loading')
        return
      }
      try {
        const data = await this.fetchGithub(this.dataset.repo)
        if (data === 'NOT_FOUND') {
          ;(this.querySelector('#gh-description') as HTMLElement).textContent =
            'Repository not found or deleted'
          this.classList.remove('loading')
          return
        }
        if (!data) {
          ;(this.querySelector('#gh-description') as HTMLElement).textContent =
            'Failed to fetch data'
          this.classList.remove('loading')
          return
        }
        ;(this.querySelector('#gh-stars') as HTMLElement).textContent = this.numberFormat(
          data.stargazers_count
        )
        ;(this.querySelector('#gh-forks') as HTMLElement).textContent = this.numberFormat(
          data.forks
        )
        ;(this.querySelector('#gh-language') as HTMLElement).textContent =
          data.language || 'No Language Specified'
        ;(this.querySelector('#gh-description') as HTMLElement).textContent =
          typeof data.description === 'string'
            ? data.description.replace(/:[a-zA-Z0-9_]+:/g, '')
            : 'Description not set'

        const licenseEl = this.querySelector('#gh-license') as HTMLElement
        if (data.license?.spdx_id) {
          licenseEl.textContent = data.license.spdx_id
        } else {
          licenseEl.classList.add('no-license')
        }

        const avatarEl = this.querySelector('#gh-avatar') as HTMLElement
        if (avatarEl) {
          avatarEl.style.backgroundImage = `url(${data.owner.avatar_url})`
          avatarEl.style.backgroundColor = 'transparent'
        }

        this.classList.remove('loading')
      } catch (e) {
        console.error('Error setting Github data:', e)
        ;(this.querySelector('#gh-description') as HTMLElement).textContent = 'Failed to fetch data'
      }
    }
  }

  if (!customElements.get('github-card')) {
    customElements.define('github-card', GithubCard)
  }
</script>
