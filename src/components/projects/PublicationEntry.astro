---
import type { ImageMetadata } from 'astro'
import { Image } from 'astro:assets'

import { cn } from '@/utils'

interface Link {
  type: string
  href: string
}

export interface Props {
  class?: string
  name: string
  authors: string
  venue: string
  year: string
  image?: string
  video?: string
  imageAlt?: string
  links: Link[]
  details?: string
}

const {
  class: className,
  name,
  authors,
  venue,
  year,
  image: imageName,
  video: videoName,
  imageAlt,
  links,
  details
} = Astro.props

const images = import.meta.glob<{ default: ImageMetadata }>(
  '/src/assets/projects/**/*.{jpeg,jpg,png,gif,webp}'
)
const videos = import.meta.glob<{ default: string }>('/src/assets/projects/**/*.{mp4,webm}')

let imagePath: string | null = null
if (imageName) {
  const resolvedPath = `/src/assets/projects/${imageName}`
  if (images[resolvedPath]) {
    imagePath = resolvedPath
  } else {
    console.warn(
      `Image "${resolvedPath}" does not exist in glob: "src/assets/projects/*.{jpeg,jpg,png,gif,webp}". It will not be displayed.`
    )
  }
}

let videoSrc: string | null = null
if (videoName) {
  const resolvedPath = `/src/assets/projects/${videoName}`
  if (videos[resolvedPath]) {
    videoSrc = (await videos[resolvedPath]!()).default
  } else {
    console.warn(
      `Video "${resolvedPath}" does not exist in glob: "src/assets/projects/*.{mp4,webm}". It will not be displayed.`
    )
  }
}

function getIconId(type: string): string | null {
  switch (type) {
    case 'github':
      return 'mingcute-github-2-line'
    case 'site':
      return 'mingcute-earth-2-line'
    case 'doc':
      return 'mingcute-document-3-line'
    case 'release':
      return 'mingcute-package-2-line'
    case 'arxiv':
      return 'mingcute-arxiv-2-line'
    case 'slide':
      return 'mingcute-slide-2-line'
    case 'video':
      return 'mingcute-video-2-line'
    default:
      return null
  }
}

---

<article class={cn('relative overflow-hidden rounded-2xl border border-border', className)}>
  {
    videoSrc ? (
      <video
        class='absolute end-0 z-0 m-0 h-full w-2/4 object-cover opacity-0 transition-opacity duration-500 pointer-events-none data-[ready=true]:opacity-60 [@media(max-aspect-ratio:1/1)]:w-full'
        data-bg-video
        data-ready='false'
        data-src={videoSrc}
        muted
        playsinline
        loop
        preload='none'
        aria-hidden='true'
        tabindex='-1'
        style={{
          maskImage: 'linear-gradient(to right, rgba(0, 0, 0, 0) 0%, rgba(0, 0, 0, 1) 100%)',
          msMaskImage: '-ms-linear-gradient(to right, rgba(0, 0, 0, 0) 0%, rgba(0, 0, 0, 1) 100%)',
          WebkitMaskImage:
            '-webkit-linear-gradient(to right, rgba(0, 0, 0, 0) 0%, rgba(0, 0, 0, 1) 100%)'
        }}
      />
    ) : (
      imagePath && (
        <Image
          class='absolute end-0 z-0 m-0 h-full w-2/4 object-cover opacity-60 [@media(max-aspect-ratio:1/1)]:w-full'
          src={images[imagePath]!()}
          widths={[240, 400, 800]}
          sizes='(max-width: 768px) 67vw, 400px'
          quality={55}
          alt={imageAlt || name}
          loading='lazy'
          style={{
            maskImage: 'linear-gradient(to right, rgba(0, 0, 0, 0) 0%, rgba(0, 0, 0, 1) 100%)',
            msMaskImage:
              '-ms-linear-gradient(to right, rgba(0, 0, 0, 0) 0%, rgba(0, 0, 0, 1) 100%)',
            WebkitMaskImage:
              '-webkit-linear-gradient(to right, rgba(0, 0, 0, 0) 0%, rgba(0, 0, 0, 1) 100%)'
          }}
        />
      )
    )
  }
  <div
    class={cn(
      'relative flex flex-col gap-y-0.5 px-3 pt-4 pb-2',
      imagePath || videoSrc ? 'me-20' : ''
    )}
  >
    <div class='text-lg font-medium text-foreground no-underline transition-colors sm:text-xl'>
      {name}
    </div>

    <p class='mt-0 mb-[1.25em] text-sm text-muted-foreground' set:html={authors} />
    {details && <p class='mt-0 mb-[1.25em] text-sm text-muted-foreground' set:html={details} />}
    {
      (venue || year) && (
        <p class='mt-0 mb-[1.25em] text-xs text-muted-foreground'>
          {venue && <i>{venue}</i>}
          {venue && year && 'â€¢ '}
          {year}
        </p>
      )
    }
    {
      links && links.length > 0 && (
        <div class='mt-0.5 flex flex-row items-center gap-x-2 sm:gap-x-2.5'>
          {links.map((link) => {
            const iconId = getIconId(link.type)
            return iconId ? (
              <a
                href={link.href}
                class='rounded-full bg-muted p-1 text-muted-foreground transition-colors hover:text-primary sm:p-1.5'
                aria-label={link.type}
                target='_blank'
                rel='noopener noreferrer'
              >
                <svg class='size-4 sm:size-5'>
                  <use href={`/icons/project.svg#${iconId}`} />
                </svg>
              </a>
            ) : null
          })}
        </div>
      )
    }
  </div>
</article>

<script>
  const w = window as Window & { __publicationEntryBgVideoInit?: boolean }
  const reduceMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches
  const saveData = (navigator as Navigator & { connection?: { saveData?: boolean } }).connection?.saveData
  const bgVideos = Array.from(document.querySelectorAll<HTMLVideoElement>('video[data-bg-video]'))

  if (!w.__publicationEntryBgVideoInit && !reduceMotion && !saveData && bgVideos.length) {
    w.__publicationEntryBgVideoInit = true
    const onIdle = window.requestIdleCallback || ((cb) => setTimeout(cb, 1))

    onIdle(() => {
      const io = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          const video = entry.target as HTMLVideoElement

          if (entry.isIntersecting) {
            if (!video.src) {
              video.src = video.dataset.src!
              video.addEventListener('loadeddata', () => (video.dataset.ready = 'true'), {
                once: true
              })
            }
            video.play()
          } else {
            video.pause()
          }
        })
      })

      bgVideos.forEach((video) => io.observe(video))
    })
  }
</script>
