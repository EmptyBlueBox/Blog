---
import PageLayout from '@/layouts/BaseLayout.astro'
import { Image } from 'astro:assets'

import PostPreview from '@/components/blog/PostPreview.astro'
import Section from '@/components/home/Section.astro'
import { Button, Card, Label } from '@/components/user'
import { getAllCollections, sortMDByDate } from '@/utils'
// Import different sizes for responsive images
import avatarMobile from '@/assets/about/7-160x160.webp'
import avatarDesktop from '@/assets/about/7-320x320.webp'
import avatarHighDPI from '@/assets/about/7-720x720.webp'
import { siteConfig } from '@/site-config'

const MAX_POSTS = 10
const allPosts = await getAllCollections()
const allPostsByDate = sortMDByDate(allPosts).slice(0, MAX_POSTS)
---

<style>
  /* Click-to-refresh styles */
  #total-pageview-count {
    cursor: pointer;
  }

  #total-pageview-count:hover {
    color: #0077ed;
  }

  #total-pageview-count:focus-visible {
    outline: 2px solid #0077ed;
    outline-offset: 2px;
  }

  /* Partial-loading state styles */
  #total-pageview-count[title*='Partially loaded'] {
    color: #ff8c00;
    position: relative;
  }

  #total-pageview-count[title*='Partially loaded']:after {
    content: '';
    position: absolute;
    top: -2px;
    right: -8px;
    width: 6px;
    height: 6px;
    background-color: #ff8c00;
    border-radius: 50%;
    animation: warningPulse 2s infinite;
  }

  @keyframes warningPulse {
    0%,
    100% {
      opacity: 1;
      transform: scale(1);
    }
    50% {
      opacity: 0.3;
      transform: scale(1.2);
    }
  }

  /* Dark theme: partial-loading state */
  :global(.dark) #total-pageview-count[title*='Partially loaded'] {
    color: #ffa500;
  }

  :global(.dark) #total-pageview-count[title*='Partially loaded']:after {
    background-color: #ffa500;
  }

  /* Pageview counter container */
  .pageview-counter-wrapper {
    display: inline-block;
    position: relative;
  }

  /* Loading indicator */
  .loading-indicator {
    display: none;
    align-items: center;
    gap: 6px;
    margin-left: 6px;
  }

  .loading-indicator.show {
    display: inline-flex;
  }

  /* Progress bar */
  .progress-bar {
    width: 32px;
    height: 2px;
    background-color: rgba(0, 122, 255, 0.15);
    border-radius: 1px;
    overflow: hidden;
    position: relative;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #007aff, #5ac8fa);
    border-radius: 1px;
    transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    width: 0%;
  }

  /* Progress text */
  .progress-text {
    font-size: 10px;
    color: #007aff;
    font-weight: 500;
    min-width: 24px;
    text-align: center;
  }

  /* Dark theme */
  :global(.dark) #total-pageview-count:hover {
    color: #0a84ff;
  }

  :global(.dark) #total-pageview-count:focus-visible {
    outline: 2px solid #0a84ff;
    outline-offset: 2px;
  }

  :global(.dark) .progress-bar {
    background-color: rgba(10, 132, 255, 0.2);
  }

  :global(.dark) .progress-fill {
    background: linear-gradient(90deg, #0a84ff, #5ac8fa);
  }

  :global(.dark) .progress-text {
    color: #0a84ff;
  }

  /* Tooltip styles */
  .pageview-tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    margin-bottom: 8px;
    padding: 10px 14px;
    background-color: rgba(255, 255, 255, 0.95);
    color: #1f2937;
    border-radius: 8px;
    font-size: 12px;
    line-height: 1.4;
    white-space: nowrap;
    opacity: 0;
    visibility: hidden;
    transition:
      opacity 0.3s ease,
      visibility 0.3s ease,
      transform 0.3s ease;
    transform: translateX(-50%) translateY(-4px);
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
  }

  .pageview-tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 5px solid transparent;
    border-top-color: rgba(255, 255, 255, 0.95);
  }

  .pageview-counter-wrapper:hover .pageview-tooltip {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(0);
  }

  /* Dark theme tooltip */
  :global(.dark) .pageview-tooltip {
    background-color: rgba(0, 0, 0, 0.9);
    color: white;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  :global(.dark) .pageview-tooltip::after {
    border-top-color: rgba(0, 0, 0, 0.9);
  }

  /* Tooltip content styles */
  .tooltip-item {
    display: flex;
    align-items: center;
    gap: 6px;
    margin: 2px 0;
  }

  .tooltip-item:first-child {
    margin-top: 0;
  }

  .tooltip-item:last-child {
    margin-bottom: 0;
  }

  .tooltip-label {
    font-weight: 600;
    color: #007aff;
  }

  :global(.dark) .tooltip-label {
    color: #0a84ff;
  }
</style>

<PageLayout meta={{ title: 'Home' }} highlightColor='#659EB966'>
  <div class='flex w-full flex-col gap-y-10 md:w-4/5 lg:w-5/6'>
    <section class='animate flex flex-col items-center gap-y-8'>
      <div class='flex items-center gap-x-6'>
        <div
          class='flex-shrink-0 overflow-hidden rounded-full shadow-sm transition-shadow duration-300 hover:shadow-md'
        >
          <img
            src={avatarMobile.src}
            srcset={`${avatarMobile.src} 160w, ${avatarDesktop.src} 320w, ${avatarHighDPI.src} 720w`}
            sizes='(max-width: 768px) 160px, (max-width: 1200px) 320px, 160px'
            alt='Profile photo of Yutong Liang'
            class='h-40 w-40 object-cover'
            loading='eager'
            fetchpriority='high'
            width='160'
            height='160'
          />
        </div>

        <div class='flex flex-col items-start gap-y-4'>
          <h1 class='text-4xl font-medium tracking-tight'>{siteConfig.author}</h1>
          <div class='flex flex-wrap gap-x-5 gap-y-3'>
            <Label
              title='Beijing Â· China'
              class='text-gray-600 transition-colors hover:text-gray-900 dark:text-gray-300 dark:hover:text-gray-100'
            >
              <svg class='size-5' slot='icon'>
                <use href='/icons/social.svg#mingcute-location-line'></use>
              </svg>
            </Label>
          </div>
        </div>
      </div>
    </section>

    <div class='mb-0 mt-0 flex flex-wrap justify-center text-sm'>
      <div class='pageview-counter-wrapper'>
        <div
          id='pageview-counter'
          class='pageview-counter flex items-center gap-2 rounded-2xl border border-border px-5 py-2'
        >
          <svg
            class='size-4 text-blue-500'
            xmlns='http://www.w3.org/2000/svg'
            viewBox='0 0 24 24'
            fill='none'
            stroke='currentColor'
            stroke-width='2'
            stroke-linecap='round'
            stroke-linejoin='round'
          >
            <line x1='18' y1='20' x2='18' y2='10'></line>
            <line x1='12' y1='20' x2='12' y2='4'></line>
            <line x1='6' y1='20' x2='6' y2='14'></line>
          </svg>
          <span class='text-gray-700 dark:text-gray-300'>
            <span class='inline-flex items-center gap-1.5'>
              <span
                >Home <span class='waline-pageview-count font-medium' data-path='/'>-</span></span
              >
              <span class='text-gray-400'>|</span>
              <span class='inline-flex items-center gap-1'>
                <span
                  >Site <span
                    id='total-pageview-count'
                    class='font-medium transition-all duration-300'
                    title='Click to refresh (includes all blog posts)'
                    role='button'
                    tabindex='0'
                    aria-live='polite'
                    aria-label='Total site pageviews. Click or press Enter/Space to refresh.'
                    >-</span
                  ></span
                >
                <div id='loading-indicator' class='loading-indicator'>
                  <div class='progress-bar'>
                    <div id='progress-fill' class='progress-fill'></div>
                  </div>
                  <span id='progress-text' class='progress-text'>0%</span>
                </div>
              </span>
            </span>
          </span>
        </div>
        <div class='pageview-tooltip'>
          <div class='tooltip-item'>
            <span class='tooltip-label'>Home:</span>
            <span>Homepage (this page) visit count</span>
          </div>
          <div class='tooltip-item'>
            <span class='tooltip-label'>Site:</span>
            <span>All pages visit count</span>
          </div>
        </div>
      </div>
    </div>

    <Section title='About'>
      <p>
        Hi there! ðŸ‘‹ I'm Yutong Liang, a 4th-year undergraduate at the School of EECS, Peking
        University, majoring in Computer Science.
      </p>
      <p>
        I have a vision of creating generalist agents that can do what we humans can do. I'm
        particularly interested in endowing them with human-level dexterity to master contact-rich
        human-object interaction (HOI) and in-hand manipulation tasks.
      </p>
      <Button title='More About Me' class='w-fit px-5 py-3' href='/about' style='ahead'>
        More About Me
      </Button>
    </Section>

    <Section title='Education'>
      <Card
        as='a'
        heading='Peking University'
        subheading='Bachelor of Science'
        date='Sep. 2021 - Jul. 2025'
        href='https://english.pku.edu.cn/'
        imagePath='/src/assets/homepage/pku-189x189.webp'
        desktopImagePath='/src/assets/homepage/pku-280x280.webp'
        highDPIImagePath='/src/assets/homepage/pku-360x360.webp'
      >
        <ul class='ms-4 list-disc text-muted-foreground'>
          <li>Specialty: Computer Science and Technology</li>
          <li>Location: Beijing, China</li>
        </ul>
      </Card>
      <Card
        as='a'
        heading='Nankai High School'
        subheading='High School Diploma'
        date='Sep. 2018 - Jul. 2021'
        href='https://nkzx.tj.edu.cn/'
        imagePath='/src/assets/homepage/nk-189x189.webp'
      >
        <ul class='ms-4 list-disc text-muted-foreground'>
          <li>Location: Tianjin, China</li>
        </ul>
      </Card>
    </Section>

    {
      allPostsByDate.length > 0 && (
        <Section title='Blog'>
          <ul class='flex flex-col gap-y-1.5 sm:gap-y-2'>
            {allPostsByDate.map((p) => (
              <li class='flex flex-col gap-x-2 sm:flex-row'>
                <PostPreview post={p} />
              </li>
            ))}
          </ul>
          <Button title='More Posts' class='w-fit px-5 py-3' href='/blog' style='ahead' />
        </Section>
      )
    }
  </div>
</PageLayout>

<script>
  // Optimize pageview counter loading
  function initPageview() {
    import('@/utils/pageview.js')
      .then((module) => {
        if (module.initPageviewCounter) {
          module.initPageviewCounter()
        }
      })
      .catch((err) => console.warn('Pageview script load failed:', err))
  }

  // Load pageview counter on user interaction or after delay
  const loadEvents = ['click', 'scroll', 'keydown', 'touchstart']
  let loaded = false

  function loadPageview() {
    if (loaded) return
    loaded = true
    initPageview()
  }

  loadEvents.forEach((event) => {
    document.addEventListener(event, loadPageview, { once: true, passive: true })
  })

  // Fallback: load after 3 seconds
  setTimeout(loadPageview, 3000)
</script>
