---
import PageLayout from '@/layouts/BaseLayout.astro'
import { Image } from 'astro:assets'

import PostPreview from '@/components/blog/PostPreview.astro'
import Section from '@/components/home/Section.astro'
import SocialLinksRow from '@/components/about/SocialLinksRow.astro'
import PublicationEntry from '@/components/projects/PublicationEntry.astro'
import { Button, Card, Label } from '@/components/user'
import { publicationsData } from '@/data/publications'
import { getCanonicalCollections, sortMDByDate } from '@/utils/collections'
import avatarMain from '@/assets/avatar/avatar_main.jpeg'
import ucsdImage from '@/assets/homepage/source/ucsd_1024.png'
import pkuImage from '@/assets/homepage/source/pku_360.png'
// import nkImage from '@/assets/homepage/source/nk_1182x1134.png'
import { siteConfig } from '@/site-config'

const MAX_POSTS = 10

const socialLinks = [
  {
    href: 'mailto:lyt0112@outlook.com',
    label: 'Email',
    icon: 'mail'
  },
  {
    href: 'https://github.com/EmptyBlueBox',
    label: 'GitHub',
    icon: 'github'
  },
  {
    href: 'https://scholar.google.com/citations?user=YtGyys8AAAAJ&hl=en',
    label: 'Google Scholar',
    icon: 'google-scholar'
  },
  {
    href: 'https://x.com/YutongLiang_',
    label: 'X',
    icon: 'x'
  }
]

const allPosts = await getCanonicalCollections()
const allPostsByDate = sortMDByDate(allPosts).slice(0, MAX_POSTS)
const blogPageviewPathSet = new Set(allPosts.map((post) => `/blog/${post.slug}`))
const blogPageviewPaths = Array.from(blogPageviewPathSet)
const blogPageviewPathsJson = JSON.stringify(blogPageviewPaths)
void blogPageviewPathsJson

declare global {
  interface Window {
    __WALINE_PAGEVIEW_PATHS__?: unknown
  }
}
---

<style>
  /* Click-to-refresh styles */
  #total-pageview-count {
    cursor: pointer;
  }

  #total-pageview-count:hover {
    color: hsl(var(--primary));
  }

  #total-pageview-count:focus-visible {
    outline: 2px solid hsl(var(--primary));
    outline-offset: 2px;
  }

  /* Partial-loading state styles */
  #total-pageview-count[title*='Partially loaded'] {
    color: hsl(var(--destructive));
    position: relative;
  }

  #total-pageview-count[title*='Partially loaded']::after {
    content: '';
    position: absolute;
    top: -2px;
    right: -8px;
    width: 6px;
    height: 6px;
    background-color: hsl(var(--destructive));
    border-radius: 50%;
    animation: warningPulse 2s infinite;
  }

  @keyframes warningPulse {
    0%,
    100% {
      opacity: 1;
      transform: scale(1);
    }
    50% {
      opacity: 0.3;
      transform: scale(1.2);
    }
  }

  /* Pageview counter container */
  .pageview-counter-wrapper {
    display: inline-block;
    position: relative;
  }

  /* Loading indicator */
  .loading-indicator {
    display: none;
    align-items: center;
    gap: 6px;
    margin-left: 6px;
  }

  .loading-indicator.show {
    display: inline-flex;
  }

  /* Progress bar */
  .progress-bar {
    width: 32px;
    height: 2px;
    background-color: hsl(var(--primary) / 0.15);
    border-radius: 1px;
    overflow: hidden;
    position: relative;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(
      90deg,
      hsl(var(--primary)),
      hsl(var(--primary) / 0.6)
    );
    border-radius: 1px;
    transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    width: 0%;
  }

  /* Progress text */
  .progress-text {
    font-size: 10px;
    color: hsl(var(--primary));
    font-weight: 500;
    min-width: 24px;
    text-align: center;
  }

  /* Tooltip styles */
  .pageview-tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    margin-bottom: 8px;
    padding: 10px 14px;
    background-color: hsl(var(--card) / 0.95);
    color: hsl(var(--foreground));
    border-radius: 8px;
    font-size: 12px;
    line-height: 1.4;
    white-space: nowrap;
    opacity: 0;
    visibility: hidden;
    transition:
      opacity 0.3s ease,
      visibility 0.3s ease,
      transform 0.3s ease;
    transform: translateX(-50%) translateY(-4px);
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
  }

  .pageview-tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 5px solid transparent;
    border-top-color: hsl(var(--card) / 0.95);
  }

  .pageview-counter-wrapper:hover .pageview-tooltip {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(0);
  }

  /* Dark theme tooltip */
  :global(.dark) .pageview-tooltip {
    background-color: hsl(var(--popover) / 0.96);
    color: hsl(var(--popover-foreground));
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  :global(.dark) .pageview-tooltip::after {
    border-top-color: hsl(var(--popover) / 0.96);
  }

  /* Tooltip content styles */
  .tooltip-item {
    display: flex;
    align-items: center;
    gap: 6px;
    margin: 2px 0;
  }

  .tooltip-item:first-child {
    margin-top: 0;
  }

  .tooltip-item:last-child {
    margin-bottom: 0;
  }

  .tooltip-label {
    font-weight: 600;
    color: hsl(var(--primary));
  }

  :global(.dark) .tooltip-label {
    color: hsl(var(--primary));
  }
</style>

<PageLayout meta={{ title: 'Home' }} highlightColor='#659EB966'>
  <div class='mx-auto flex w-full flex-col gap-y-10 md:w-4/5 lg:w-5/6'>
    <section class='animate flex flex-col items-center gap-y-8'>
      <div class='flex items-center gap-x-6'>
        <div
          class='flex-shrink-0 overflow-hidden rounded-full shadow-sm transition-shadow duration-300 hover:shadow-md'
        >
          <Image
            src={avatarMain}
            densities={[1, 2, 4.5]}
            width={160}
            height={160}
            alt='Profile photo of Yutong Liang'
            class='h-40 w-40 object-cover'
            priority
          />
        </div>

        <div class='flex flex-col items-start gap-y-4'>
          <h1 class='text-4xl font-medium tracking-tight'>{siteConfig.author}</h1>
          <div class='flex flex-wrap gap-x-5 gap-y-3'>
            <Label title='San Diego Â· US' class='text-muted-foreground'>
              <svg class='size-5' slot='icon'>
                <use href='/icons/social.svg#mingcute-location-line'></use>
              </svg>
            </Label>
            <Label title='Robotics Â· Character Animation' class='text-muted-foreground'>
              <svg class='size-5' slot='icon'>
                <use href='/icons/social.svg#academic-cap'></use>
              </svg>
            </Label>
          </div>
        </div>
      </div>
    </section>

    <div class='mb-0 mt-0 flex flex-wrap justify-center text-sm'>
      <div class='pageview-counter-wrapper'>
        <div
          id='pageview-counter'
          class='pageview-counter flex items-center gap-2 rounded-2xl border border-border px-5 py-2'
        >
          <svg
            class='size-4 text-blue-500'
            xmlns='http://www.w3.org/2000/svg'
            viewBox='0 0 24 24'
            fill='none'
            stroke='currentColor'
            stroke-width='2'
            stroke-linecap='round'
            stroke-linejoin='round'
          >
            <line x1='18' y1='20' x2='18' y2='10'></line>
            <line x1='12' y1='20' x2='12' y2='4'></line>
            <line x1='6' y1='20' x2='6' y2='14'></line>
          </svg>
          <span class='text-muted-foreground'>
            <span class='inline-flex items-center gap-1.5'>
              <span
                >Home <span
                  class='waline-pageview-count font-medium'
                  data-counter-label='Home views'
                  data-path='/'
                  >-</span
                ></span
              >
              <span class='text-muted-foreground/80'>|</span>
              <span class='inline-flex items-center gap-1'>
                <span
                  >Site <span
                    id='total-pageview-count'
                    class='font-medium transition-all duration-300'
                    title='Click to refresh (includes all blog posts)'
                    role='button'
                    tabindex='0'
                    aria-live='polite'
                    aria-label='Total site pageviews. Click or press Enter/Space to refresh.'
                    >-</span
                  ></span
                >
                <div id='loading-indicator' class='loading-indicator'>
                  <div class='progress-bar'>
                    <div id='progress-fill' class='progress-fill'></div>
                  </div>
                  <span id='progress-text' class='progress-text'>0%</span>
                </div>
              </span>
            </span>
          </span>
        </div>
        <div class='pageview-tooltip'>
          <div class='tooltip-item'>
            <span class='tooltip-label'>Home:</span>
            <span>Homepage (this page) visit count</span>
          </div>
          <div class='tooltip-item'>
            <span class='tooltip-label'>Site:</span>
            <span>All pages visit count</span>
          </div>
        </div>
      </div>
    </div>

    <Section title='About'>
      <p>
        Hi there! ðŸ‘‹ I'm Yutong Liang, a first-year graduate student in Computer Science and Engineering at the University of California San Diego, advised by Prof. Xiaolong Wang.
      </p>
      <p>
        My research focuses on dexterous robotic manipulation. I study human-object interaction and learning-based control with the long-term goal of building embodied agents that operate just like human. I believe human demonstration prior is a practical way to faster, safer, and reliable robotic learning.
      </p>
      <p>
        During my undergraduate years, I was a research student at the Visual Computing and Learning Lab at Peking University, advised by Prof. Libin Liu, where I worked on character animation and physics simulation.
      </p>
      <SocialLinksRow links={socialLinks} />
      <Button title='More About Me' class='w-fit px-5 py-3' href='/about' style='ahead'>
        More About Me
      </Button>
    </Section>

    <Section title='Education'>
      <Card
        as='a'
        heading='University of California San Diego'
        location='San Diego, United States'
        date='Sep. 2025 - Jul. 2027 (Expected)'
        href='https://cse.ucsd.edu'
        image={ucsdImage}
        isLCP={true}
      >
        <ul class='ms-4 list-disc text-muted-foreground'>
          <li>Jacobs School of Engineering</li>
          <li>M.S. in Computer Science and Engineering</li>
        </ul>
      </Card>
      <Card
        as='a'
        heading='Peking University'
        location='Beijing, China'
        date='Sep. 2021 - Jul. 2025'
        href='https://english.pku.edu.cn/'
        image={pkuImage}
        isLCP={true}
      >
        <ul class='ms-4 list-disc text-muted-foreground'>
          <li>School of EECS</li>
          <li>B.S. in Computer Science and Technology</li>
        </ul>
      </Card>
      <!-- <Card
        as='a'
        heading='Nankai High School'
        location='Tianjin, China'
        date='Sep. 2018 - Jul. 2021'
        href='https://nkzx.tj.edu.cn/'
        image={nkImage}
      >
        <ul class='ms-4 list-disc text-muted-foreground'>
          <li>High School Diploma</li>
        </ul>
      </Card> -->
    </Section>

    <Section title='Publications'>
      <div class='grid grid-cols-1 gap-4'>
        {
          publicationsData.slice(0, 3).map((pub) => (
            <PublicationEntry
              name={pub.name}
              authors={pub.authors}
              venue={pub.venue}
              year={pub.year}
              image={pub.image}
              links={pub.links}
            />
          ))
        }
      </div>
      <Button
        title='More Publications'
        class='w-fit px-5 py-3'
        href='/projects#publications'
        style='ahead'
      />
    </Section>

    {
      allPostsByDate.length > 0 && (
        <Section title='Blog'>
          <ul class='flex flex-col gap-y-1.5 sm:gap-y-2'>
            {allPostsByDate.map((p) => (
              <li class='flex flex-col gap-x-2 sm:flex-row'>
                <PostPreview post={p} />
              </li>
            ))}
          </ul>
          <Button title='More Posts' class='w-fit px-5 py-3' href='/blog' style='ahead' />
        </Section>
      )
    }
  </div>
</PageLayout>

<script is:inline type='application/json' id='waline-pageview-paths'>
  {blogPageviewPathsJson}
</script>

<script>
  // Preload blog post paths for pageview aggregation without extra network requests
  ;(() => {
    if (typeof window === 'undefined') return
    const walineGlobalKey = '__WALINE_PAGEVIEW_PATHS__'
    const walinePageviewPaths = window[walineGlobalKey]
    if (Array.isArray(walinePageviewPaths)) return

    const pathSource = document.getElementById('waline-pageview-paths')
    if (!pathSource) return

    try {
      const rawContent = pathSource.textContent ?? '[]'
      const parsed = JSON.parse(rawContent)
      if (Array.isArray(parsed)) {
        window[walineGlobalKey] = parsed
      }
    } catch (error) {
      console.warn('Failed to parse embedded Waline pageview paths:', error)
    }
  })()

  // Optimize pageview counter loading
  const initPageview = () => {
    import('@/utils/pageview.js')
      .then((module) => {
        if (typeof module.initPageviewCounter === 'function') {
          module.initPageviewCounter()
        }
      })
      .catch((err) => console.warn('Pageview script load failed:', err))
  }

  // Load pageview counters immediately (no scroll/interaction required).
  let loaded = false
  const loadPageview = () => {
    if (loaded) return
    loaded = true
    initPageview()
  }

  const scheduleLoad = () => {
    if (typeof window !== 'undefined' && typeof window.requestIdleCallback === 'function') {
      window.requestIdleCallback(loadPageview, { timeout: 1200 })
      return
    }
    setTimeout(loadPageview, 0)
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', scheduleLoad, { once: true })
  } else {
    scheduleLoad()
  }
</script>
