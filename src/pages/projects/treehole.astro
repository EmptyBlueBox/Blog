---
import PageLayout from '@/layouts/CommonPage.astro'

import { Comment } from '@/components/advanced'
import { Aside, Button } from '@/components/user'
---

<PageLayout title='PKU Treehole Starred Saver' info='/projects/treehole'>
  <div class='mx-auto space-y-10'>
    <!-- è¯´æ˜å¡ç‰‡ -->
    <div class='space-y-3'>
      <h2 class='text-xxl font-bold'>é¡¹ç›®è¯´æ˜</h2>
      <p class='text-muted-foreground'>å¸®åŠ©åŒ—äº¬å¤§å­¦çš„åŒå­¦ä¸‹è½½è‡ªå·±åœ¨æ ‘æ´ä¸­æ”¶è—çš„å¸–å­, ç•™ä½œçºªå¿µ~</p>
      <img
        src='https://cdn.lyt0112.com/2025/07/6092978a49dd15bb33cb3be74fb571b6.png'
        alt=''
        style='width: 70%; height: auto; display: block; margin: 0 auto;'
      /><p style='text-align: center; font-style: italic; color: gray;'>ç”Ÿæˆçš„ Markdown æ–‡ä»¶ç¤ºä¾‹</p>
      <Aside type='danger' title='éšç§åŠä¾µæƒå£°æ˜'>
        <ul class='list-inside list-disc space-y-1'>
          <li>æœ¬å·¥å…·ä¸ä¼šä¿å­˜ä½ çš„ä»»ä½•éšç§ä¿¡æ¯, åŒ…æ‹¬è´¦å·ã€å¯†ç ã€éªŒè¯ç . </li>
          <li>
            æœ¬å·¥å…·å¯¹åŒ—äº¬å¤§å­¦æ ‘æ´æœåŠ¡å™¨é€ æˆçš„é¢å¤–å‹åŠ›å¾ˆå°,
            å¹¶ä¸”å¯¹è¯·æ±‚é€Ÿç‡å’Œå¹¶å‘åº¦ç»è¿‡ä¸¥æ ¼çš„å®šé‡åˆ†æ, å…·ä½“åˆ†æå¯è§ <a
              href='https://github.com/EmptyBlueBox/PKU_Treehole_Starred_Saver/blob/main/README.md'
              target='_blank'
              rel='noopener noreferrer'
            >
              README</a
            > ä¸­çš„ Rate Limit and Concurrency Analysis ä¸€èŠ‚. 
          </li>
        </ul>
      </Aside>
      <Aside type='note' title='ä½¿ç”¨æç¤º'>
        <ul class='list-inside list-disc space-y-1'>
          <li>è¯·ä½¿ç”¨åŒ—äº¬å¤§å­¦å­¦å·å’Œå¯†ç ç™»å½•. </li>
          <li>
            å¦‚æœå‡ºç°éœ€è¦è¾“å…¥æ‰‹æœºä»¤ç‰Œçš„é”™è¯¯, è¯·åœ¨è‡ªå·±çš„æµè§ˆå™¨ç™»å½•æ ‘æ´å¹¶è¾“å…¥ä»¤ç‰Œåå†å›æ¥æœ¬é¡µé¢ç»§ç»­æ“ä½œ. 
          </li>
          <li>æ”¶é›†æ•°æ®è¿‡ç¨‹å¯èƒ½éœ€è¦ä¸€åˆ†é’Ÿ, è¯·è€å¿ƒç­‰å¾…. </li>
          <li>å®Œæˆåä¼šè‡ªåŠ¨ç”Ÿæˆå¹¶ä¸‹è½½åŒ…å« Markdown æ–‡ä»¶å’Œå›¾ç‰‡çš„å‹ç¼©åŒ…. </li>
          <li>
            å¦‚æœä¸‹è½½å¤±è´¥æˆ–è€…ä¸‹è½½çš„æ–‡ä»¶æŸå, å¯èƒ½æ˜¯ç”±äºæœåŠ¡å™¨å¸¦å®½ä¸å¤Ÿ, è¯·æŠŠä»»åŠ¡ ID
            å’Œé”™è¯¯ä¿¡æ¯å‘é€åˆ°æˆ‘çš„ <a
              href='mailto:lyt0112@outlook.com'
              target='_blank'
              rel='noopener noreferrer'>é‚®ç®±</a
            >, æˆ‘ä¼šç›´æ¥æŠŠå‹ç¼©åŒ…å‘é€ç»™ä½ . 
          </li>
          <li>
            æœ¬å·¥å…·å·²å®Œå…¨å¼€æº, æ¬¢è¿è®¿é—® <a
              href='https://github.com/EmptyBlueBox/PKU_Treehole_Starred_Saver'
              target='_blank'
              rel='noopener noreferrer'>GitHub ä»“åº“</a
            > è·å–æºä»£ç ã€æ Issue æˆ–è´¡çŒ®ä»£ç . 
          </li>
          <li>
            <strong>æ³¨æ„ï¼š</strong>æœ¬å·¥å…·ä»å¤„äºå¼€å‘é˜¶æ®µ, å¦‚é‡åˆ°ä»»ä½•æ„å¤–æƒ…å†µæˆ–é—®é¢˜, è¯·é€šè¿‡ <a
              href='mailto:lyt0112@outlook.com'
              target='_blank'
              rel='noopener noreferrer'>é‚®ç®±</a
            > è”ç³»æˆ‘, æˆ‘ä¹Ÿå¾ˆä¹æ„å¸®ä½ æ‰‹åŠ¨ä¸‹è½½ï¼
          </li>
        </ul>
      </Aside>
      <Aside type='tip' title='ğŸ¥¹ æ”¯æŒä½œè€…'>
        å¦‚æœä½ è§‰å¾—æœ¬é¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©, æ¬¢è¿é€šè¿‡ <a href='/links#sponsorship'>èµèµç </a> æ”¯æŒä½œè€…ï¼æ¯•ç«Ÿæ–°ä¹°äº†ä¸ªæœåŠ¡å™¨
        (è™½ç„¶æ€§èƒ½ä¸€èˆ¬) ~
      </Aside>
    </div>

    <!-- ç™»å½•è¡¨å• -->
    <h2 class='text-xxl font-bold'>ç™»å½•è´¦æˆ·å¹¶æ”¶é›†æ•°æ®</h2>
    <div id='loginCard' class='space-y-6 rounded-2xl border border-border px-5 py-3'>
      <form id='loginForm' class='space-y-4'>
        <div class='space-y-2'>
          <label for='username' class='block text-sm font-medium'>åŒ—äº¬å¤§å­¦å­¦å·</label>
          <input
            type='text'
            id='username'
            name='username'
            required
            class='w-full rounded-lg border border-border bg-background px-3 py-2 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20'
            placeholder='è¯·è¾“å…¥åŒ—äº¬å¤§å­¦å­¦å·'
          />
        </div>
        <div class='space-y-2'>
          <label for='password' class='block text-sm font-medium'>å¯†ç </label>
          <input
            type='password'
            id='password'
            name='password'
            required
            class='w-full rounded-lg border border-border bg-background px-3 py-2 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20'
            placeholder='è¯·è¾“å…¥å¯†ç '
          />
        </div>
        <Button
          as='button'
          type='submit'
          class='w-full justify-center bg-primary text-primary-foreground hover:bg-primary/90'
        >
          ç™»å½•è´¦æˆ·å¹¶æ”¶é›†æ•°æ®
        </Button>
      </form>
    </div>

    <!-- SMSéªŒè¯è¡¨å• -->
    <div id='smsCard' class='hidden space-y-4 rounded-2xl border border-border px-5 py-3'>
      <h3 class='text-lg font-medium'>çŸ­ä¿¡éªŒè¯</h3>
      <p class='text-muted-foreground'>è¯·è¾“å…¥æ”¶åˆ°çš„çŸ­ä¿¡éªŒè¯ç </p>
      <form id='smsForm' class='space-y-4'>
        <div class='space-y-2'>
          <label for='verificationCode' class='block text-sm font-medium'>éªŒè¯ç </label>
          <input
            type='text'
            id='verificationCode'
            name='verificationCode'
            required
            maxlength='6'
            class='w-full rounded-lg border border-border bg-background px-3 py-2 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20'
            placeholder='è¯·è¾“å…¥ 4 ä½éªŒè¯ç '
          />
        </div>
        <Button
          as='button'
          type='submit'
          class='w-full justify-center bg-primary text-primary-foreground hover:bg-primary/90'
        >
          éªŒè¯
        </Button>
      </form>
    </div>

    <!-- ä»»åŠ¡çŠ¶æ€å¡ç‰‡ -->
    <div id='statusCard' class='hidden space-y-4 rounded-2xl border border-border px-5 py-3'>
      <h3 class='text-lg font-medium'>ä»»åŠ¡çŠ¶æ€</h3>

      <!-- è¿›åº¦æ¡ -->
      <div class='space-y-2'>
        <div class='flex justify-between text-sm'>
          <span id='statusText'>å‡†å¤‡ä¸­...</span>
          <span id='progressText'>0%</span>
        </div>
        <div class='h-2 w-full rounded-full bg-muted'>
          <div
            id='progressBar'
            class='h-2 rounded-full bg-primary transition-all duration-300'
            style='width: 0%'
          >
          </div>
        </div>
      </div>

      <!-- è¯¦ç»†ä¿¡æ¯ -->
      <div id='taskDetails' class='space-y-2 text-sm text-muted-foreground'>
        <div class='flex justify-between'>
          <span>ä»»åŠ¡ ID :</span>
          <span id='taskId'>-</span>
        </div>
        <div class='flex justify-between'>
          <span>é¢„è®¡å‰©ä½™æ—¶é—´:</span>
          <span id='estimatedTime'>-</span>
        </div>
        <div class='flex justify-between'>
          <span>é˜Ÿåˆ—:</span>
          <span id='queuePosition'>-</span>
        </div>
      </div>

      <!-- ä¸‹è½½æŒ‰é’® -->
      <Button
        id='downloadBtn'
        as='button'
        class='hidden w-full justify-center bg-green-600 text-white hover:bg-green-700'
      >
        ä¸‹è½½æ•°æ®
      </Button>

      <!-- é‡æ–°å¼€å§‹æŒ‰é’® -->
      <Button
        id='restartBtn'
        as='button'
        class='w-full justify-center border-primary text-primary hover:bg-primary hover:text-primary-foreground'
      >
        é‡æ–°å¼€å§‹
      </Button>
    </div>

    <!-- é”™è¯¯æ˜¾ç¤º -->
    <div
      id='errorCard'
      class='hidden rounded-2xl border border-red-500 bg-red-50 px-5 py-3 dark:bg-red-950/20'
    >
      <div class='space-y-2'>
        <h3 class='text-lg font-medium text-red-600 dark:text-red-400'>é”™è¯¯</h3>
        <p id='errorMessage' class='text-red-600 dark:text-red-400'></p>
        <Button
          id='errorRestartBtn'
          as='button'
          class='border-red-500 text-red-600 hover:bg-red-500 hover:text-white'
        >
          é‡æ–°å¼€å§‹
        </Button>
      </div>
    </div>
  </div>
  <Comment />
</PageLayout>

<script>
  // APIé…ç½® - ä½¿ç”¨ç›¸å¯¹è·¯å¾„, è¿™æ ·ä¼šè‡ªåŠ¨ä½¿ç”¨å½“å‰åŸŸåï¼ˆHTTPSï¼‰
  const API_BASE = ''

  // çŠ¶æ€ç®¡ç†
  let currentTaskId: string | null = null
  let statusCheckInterval: ReturnType<typeof setInterval> | null = null

  // è·å–DOMå…ƒç´ 
  const loginCard = document.getElementById('loginCard')
  const smsCard = document.getElementById('smsCard')
  const statusCard = document.getElementById('statusCard')
  const errorCard = document.getElementById('errorCard')

  const loginForm = document.getElementById('loginForm')
  const smsForm = document.getElementById('smsForm')

  const statusText = document.getElementById('statusText')
  const progressText = document.getElementById('progressText')
  const progressBar = document.getElementById('progressBar')
  const taskId = document.getElementById('taskId')
  const estimatedTime = document.getElementById('estimatedTime')
  const queuePosition = document.getElementById('queuePosition')

  const downloadBtn = document.getElementById('downloadBtn')
  const restartBtn = document.getElementById('restartBtn')
  const errorRestartBtn = document.getElementById('errorRestartBtn')
  const errorMessage = document.getElementById('errorMessage')

  // å·¥å…·å‡½æ•°
  function showCard(card: HTMLElement | null) {
    if (!card) return
    document
      .querySelectorAll('.max-w-4xl > div > .border')
      .forEach((c) => c.classList.add('hidden'))
    card.classList.remove('hidden')
  }

  function showError(message: string) {
    if (errorMessage) {
      errorMessage.textContent = message
    }
    showCard(errorCard)
  }

  function formatTime(seconds: number) {
    if (!seconds || seconds <= 0) return '-'
    const minutes = Math.floor(seconds / 60)
    const remainingSeconds = seconds % 60
    return `${minutes}åˆ†${remainingSeconds}ç§’`
  }

  // ç™»å½•å¤„ç†
  loginForm?.addEventListener('submit', async (e) => {
    e.preventDefault()

    const usernameInput = document.getElementById('username') as HTMLInputElement
    const passwordInput = document.getElementById('password') as HTMLInputElement

    if (!usernameInput || !passwordInput) return

    const username = usernameInput.value
    const password = passwordInput.value

    try {
      if (statusText) {
        statusText.textContent = 'æ­£åœ¨ç™»å½•...'
      }
      showCard(statusCard)

      const response = await fetch(`${API_BASE}/api/auth/login`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ username, password })
      })

      const data = await response.json()

      if (data.success) {
        currentTaskId = data.task_id
        if (taskId) {
          taskId.textContent = currentTaskId
        }
        startStatusCheck()
      } else {
        showError(data.message || 'ç™»å½•å¤±è´¥')
      }
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'
      showError('ç½‘ç»œé”™è¯¯: ' + errorMsg)
    }
  })

  // SMSéªŒè¯å¤„ç†
  smsForm?.addEventListener('submit', async (e) => {
    e.preventDefault()

    const verificationCodeInput = document.getElementById('verificationCode') as HTMLInputElement
    if (!verificationCodeInput) return

    const verificationCode = verificationCodeInput.value

    try {
      const response = await fetch(`${API_BASE}/api/auth/verify`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          task_id: currentTaskId,
          verification_code: verificationCode
        })
      })

      const data = await response.json()

      if (data.success) {
        showCard(statusCard)
        startStatusCheck()
      } else {
        showError(data.message || 'éªŒè¯å¤±è´¥')
      }
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'
      showError('ç½‘ç»œé”™è¯¯: ' + errorMsg)
    }
  })

  // çŠ¶æ€æ£€æŸ¥
  async function checkStatus() {
    if (!currentTaskId) return

    try {
      const response = await fetch(`${API_BASE}/api/crawl/status/${currentTaskId}`)
      const status = await response.json()

      // æ›´æ–°UI
      if (statusText) {
        statusText.textContent = status.message || status.status
      }
      if (progressText) {
        progressText.textContent = `${Math.round(status.progress)}%`
      }
      if (progressBar) {
        progressBar.style.width = `${status.progress}%`
      }

      if (status.estimated_time_remaining && estimatedTime) {
        estimatedTime.textContent = formatTime(status.estimated_time_remaining)
      }

      // æ ¹æ®çŠ¶æ€å¤„ç†
      switch (status.status) {
        case 'awaiting_verification':
          showCard(smsCard)
          stopStatusCheck()
          break

        case 'completed':
          if (statusText) {
            statusText.textContent = 'ä»»åŠ¡å®Œæˆï¼'
          }
          if (estimatedTime) {
            estimatedTime.textContent = '0ç§’'
          }
          if (downloadBtn) {
            downloadBtn.classList.remove('hidden')
            downloadBtn.onclick = () => {
              // ç›´æ¥ä½¿ç”¨åŸå§‹åç«¯é“¾æ¥
              const originalUrl = status.download_url

              // ä»å„ç§å¯èƒ½çš„URLæ ¼å¼ä¸­æå–æ–‡ä»¶ID
              let fileId = ''
              if (originalUrl.includes('/api/download/')) {
                // æå–æœ€åçš„æ–‡ä»¶IDéƒ¨åˆ†
                const parts = originalUrl.split('/api/download/')
                if (parts.length > 1) {
                  fileId = parts[parts.length - 1].replace(/^api\/download\//, '')
                }
              }

              // æ„é€ åŸå§‹åç«¯URL
              const backendUrl = `http://39.96.200.9:8000/api/download/${fileId}`

              window.open(backendUrl, '_blank')
            }
          }

          stopStatusCheck()
          break

        case 'failed':
          showError(status.message || 'ä»»åŠ¡å¤±è´¥')
          stopStatusCheck()
          break
        case 'crawling':
          // ä»»åŠ¡æ­£åœ¨è¿è¡Œæ—¶, æ˜¾ç¤º active_tasks ä½œä¸ºé˜Ÿåˆ—ä½ç½®
          try {
            const queueResp = await fetch(`${API_BASE}/api/queue/status`)
            const queueData = await queueResp.json()
            if (queuePosition) {
              queuePosition.textContent = `å¹¶è¡Œä»»åŠ¡æ•°ï¼š${queueData.active_tasks}`
            }
          } catch {
            if (queuePosition) queuePosition.textContent = '-'
          }
          break
        default:
          // å…¶å®ƒæƒ…å†µç»´æŒåŸé€»è¾‘
          if (status.queue_position && queuePosition) {
            queuePosition.textContent = `ç¬¬${status.queue_position}ä½, å¹¶è¡Œä»»åŠ¡æ•°ï¼š${status.active_tasks}`
          } else if (queuePosition) {
            queuePosition.textContent = '-'
          }
          break
      }
    } catch (error) {
      console.error('çŠ¶æ€æ£€æŸ¥å¤±è´¥:', error)
    }
  }

  function startStatusCheck() {
    checkStatus() // ç«‹å³æ£€æŸ¥ä¸€æ¬¡
    statusCheckInterval = setInterval(checkStatus, 3000) // æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡
  }

  function stopStatusCheck() {
    if (statusCheckInterval) {
      clearInterval(statusCheckInterval)
      statusCheckInterval = null
    }
  }

  // é‡æ–°å¼€å§‹
  function restart() {
    currentTaskId = null
    stopStatusCheck()

    // Reset forms
    ;(loginForm as HTMLFormElement)?.reset()
    ;(smsForm as HTMLFormElement)?.reset()

    // Reset UI
    if (progressBar) progressBar.style.width = '0%'
    if (progressText) progressText.textContent = '0%'
    if (downloadBtn) downloadBtn.classList.add('hidden')
    if (taskId) taskId.textContent = '-'
    if (estimatedTime) estimatedTime.textContent = '-'
    if (queuePosition) queuePosition.textContent = '-'
    // Hide error card if visible
    if (errorCard) errorCard.classList.add('hidden')

    // Show login card
    if (loginCard) showCard(loginCard)
  }

  restartBtn?.addEventListener('click', restart)
  errorRestartBtn?.addEventListener('click', restart)

  // é¡µé¢å¸è½½æ—¶æ¸…ç†
  window.addEventListener('beforeunload', () => {
    stopStatusCheck()
  })
</script>

<style>
  /* è‡ªå®šä¹‰æ ·å¼å¢å¼º */
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* è¾“å…¥æ¡†ç„¦ç‚¹å¢å¼º */
  input:focus {
    transform: scale(1.01);
    transition: all 0.2s ease-in-out;
  }

  /* è¿›åº¦æ¡åŠ¨ç”» */
  #progressBar {
    background: linear-gradient(90deg, hsl(var(--primary)), hsl(var(--primary) / 0.8));
  }

  /* æŒ‰é’®æ‚¬åœæ•ˆæœå¢å¼º */
  button:hover {
    transform: translateY(-1px);
    transition: all 0.2s ease-in-out;
  }

  /* å¡ç‰‡åˆ‡æ¢åŠ¨ç”» */
  .hidden {
    opacity: 0;
    transform: translateY(-10px);
    transition: all 0.3s ease-in-out;
  }

  .border:not(.hidden) {
    opacity: 1;
    transform: translateY(0);
    transition: all 0.3s ease-in-out;
  }
</style>
